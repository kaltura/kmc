<?xml version="1.0" encoding="utf-8"?>
<mx:VBox xmlns:mx="http://www.adobe.com/2006/mxml" creationComplete="initCategoryEndUserAcessTab(event)"
		 implements="com.kaltura.kmc.modules.content.view.window.cdw.ICategoryDrilldownPanel">
	<mx:Script>
		<![CDATA[
			import com.kaltura.kmc.modules.content.events.CategoryEvent;
			import com.kaltura.kmc.modules.content.model.CategoriesModel;
			import com.kaltura.kmc.modules.content.view.window.OneRule;
			import com.kaltura.kmc.modules.content.view.window.cdw.users.ChangeOwnerWin;
			import com.kaltura.kmc.modules.content.view.window.cdw.users.EndUsersPermissionsWin;
			import com.kaltura.types.KalturaAppearInListType;
			import com.kaltura.types.KalturaCategoryUserPermissionLevel;
			import com.kaltura.types.KalturaContributionPolicyType;
			import com.kaltura.types.KalturaInheritanceType;
			import com.kaltura.types.KalturaPrivacyType;
			import com.kaltura.types.KalturaUserJoinPolicyType;
			import com.kaltura.vo.KalturaCategory;
			
			import mx.binding.utils.BindingUtils;
			import mx.binding.utils.ChangeWatcher;
			import mx.controls.Alert;
			import mx.core.mx_internal;
			import mx.events.CloseEvent;
			import mx.events.FlexEvent;
			import mx.events.ListEvent;
			import mx.managers.PopUpManager;

			private const TEXT_WIDTH:Number = 264;
			private const LABEL_WIDTH:Number = 150;

			[Bindable]
			public var model:CategoriesModel;

			[Bindable]
			private var _category:KalturaCategory;
			
			private var _originalOwner:String;
			private var _originalJoinPolicy:int;
			private var _originalPermLvl:int;
			private var _orginalInheritanceValue:int;

			public function get category():KalturaCategory {
				return _category;
			}

			[Bindable]
			public function set category(value:KalturaCategory):void {
				
				_category = value;
				_originalOwner = value.owner;
				_originalJoinPolicy = value.userJoinPolicy;
				_originalPermLvl = value.defaultPermissionLevel;
				_orginalInheritanceValue = value.inheritanceType;
			}



			protected function initCategoryEndUserAcessTab(event:FlexEvent):void {
				// join policy:
				policyCb.dataProvider = [{label: resourceManager.getString('cms', 'jpNotAllowd'), data: KalturaUserJoinPolicyType.NOT_ALLOWED},
					{label: resourceManager.getString('cms', 'jpAutoJoin'), data: KalturaUserJoinPolicyType.AUTO_JOIN},
					{label: resourceManager.getString('cms', 'jpRequestToJoin'), data: KalturaUserJoinPolicyType.REQUEST_TO_JOIN}];
				if (_category && _category.userJoinPolicy == int.MIN_VALUE) {
					_category.userJoinPolicy = KalturaUserJoinPolicyType.NOT_ALLOWED;
				}
				
				// default permissions
				levelCb.dataProvider = [{label: resourceManager.getString('cms', 'permLvlMember'), data: KalturaCategoryUserPermissionLevel.MEMBER},
					{label: resourceManager.getString('cms', 'permLvlContributor'), data: KalturaCategoryUserPermissionLevel.CONTRIBUTOR},
					{label: resourceManager.getString('cms', 'permLvlModerator'), data: KalturaCategoryUserPermissionLevel.MODERATOR},
					{label: resourceManager.getString('cms', 'permLvlManager'), data: KalturaCategoryUserPermissionLevel.MANAGER}];
				if (_category && _category.defaultPermissionLevel == int.MIN_VALUE) {
					_category.defaultPermissionLevel = KalturaCategoryUserPermissionLevel.MEMBER;
				}
				
				setCBValuesFromCategory();
			}

			private function setCBValuesFromCategory():void {
				switch (_category.userJoinPolicy) {
					case KalturaUserJoinPolicyType.NOT_ALLOWED:
						policyCb.selectedIndex = 0;
						break;
					case KalturaUserJoinPolicyType.AUTO_JOIN:
						policyCb.selectedIndex = 1;
						break;
					case KalturaUserJoinPolicyType.REQUEST_TO_JOIN:
						policyCb.selectedIndex = 2;
						break;
				}

				switch (_category.defaultPermissionLevel) {
					case KalturaCategoryUserPermissionLevel.MEMBER:
						levelCb.selectedIndex = 0;
						break;
					case KalturaCategoryUserPermissionLevel.CONTRIBUTOR:
						levelCb.selectedIndex = 1;
						break;
					case KalturaCategoryUserPermissionLevel.MODERATOR:
						levelCb.selectedIndex = 2;
						break;
					case KalturaCategoryUserPermissionLevel.MANAGER:
						levelCb.selectedIndex = 3;
						break;
				}	
			}

			/**
			 * open the end user permissions popup
			 * */
			protected function openEndUserPermissions():void {
				var cowin:EndUsersPermissionsWin = new EndUsersPermissionsWin();
				cowin.category = _category;
				cowin.model = model;
				PopUpManager.addPopUp(cowin, this, true);
				PopUpManager.centerPopUp(cowin);
			}


			protected function changeOwner():void {
				var cowin:ChangeOwnerWin = new ChangeOwnerWin();
				cowin.category = _category;
				PopUpManager.addPopUp(cowin, this, true);
				PopUpManager.centerPopUp(cowin);
			}


			public function validate():void {

			}


			public function save():void {
				if (category.inheritanceType == KalturaInheritanceType.INHERIT) {
					// make sure we don't send inherited fields
					category.userJoinPolicy = int.MIN_VALUE;
					category.owner = null;
					category.defaultPermissionLevel = int.MIN_VALUE;
				}
			}


			public function destroy():void {

			}


			public function clear():void {
				var cgEvent:CategoryEvent = new CategoryEvent(CategoryEvent.CLEAR_PARENT_CATEGORY);
				cgEvent.dispatch();
			}


			public function initData():void {
				if (!_category.privacyContexts) {
					if (this.parent) {
						this.parent.removeChild(this);
					}
					return;
				}
				var cgEvent:CategoryEvent;
				if (_category.parentId > 0) {
					cgEvent = new CategoryEvent(CategoryEvent.GET_PARENT_CATEGORY);
					cgEvent.data = _category;
					cgEvent.dispatch();
				}
				if (_category.inheritanceType == KalturaInheritanceType.INHERIT) {
					cgEvent = new CategoryEvent(CategoryEvent.GET_INHERITED_PARENT_CATEGORY);
					cgEvent.data = _category;
					cgEvent.dispatch();
				}
			}


			public function init():void {

			}


			public function isChanged():Boolean {
				return false;
			}


			private function levelCb_changeHandler(event:ListEvent):void {
				_category.defaultPermissionLevel = levelCb.selectedItem.data;
			}


			private function policyCb_changeHandler(event:ListEvent):void {
				_category.userJoinPolicy = policyCb.selectedItem.data;
			}

			
			private function inheritNo_changeHandler(event:Event):void {
				if((event.target as RadioButton).selected) {
					_category.inheritanceType = KalturaInheritanceType.MANUAL; 
					_category.owner = _originalOwner;
					_category.userJoinPolicy = _originalJoinPolicy;
					_category.defaultPermissionLevel = _originalPermLvl;
					setCBValuesFromCategory();
				}
			}


			
			private function inheritYes_changeHandler(event:Event):void {
				if((event.target as RadioButton).selected) {
					if (_orginalInheritanceValue == KalturaInheritanceType.MANUAL) {
						// show alert
						Alert.show(resourceManager.getString('cms', 'attention'), resourceManager.getString('cms', 'attention'), Alert.OK|Alert.CANCEL, null, approveInherit);
					}
					else {
						approveInherit();	
					}
							
				}
			}
			
			private function approveInherit(e:CloseEvent = null):void {
				if (!e || e.detail == Alert.OK) {
					_category.inheritanceType = KalturaInheritanceType.INHERIT;
					var parentCat:KalturaCategory = model.inheritedParentCategory;
					if (!parentCat) {
						parentCat = model.parentCategory;
					}
					_category.owner = parentCat.owner;
					_category.userJoinPolicy = parentCat.userJoinPolicy;
					_category.defaultPermissionLevel = parentCat.defaultPermissionLevel;
					setCBValuesFromCategory();
				}
			}

		]]>
	</mx:Script>
	<mx:Label text="{resourceManager.getString('cms', 'endUserAccessTitle')}"/>
	<mx:HBox width="100%">
		<mx:Image source="{StyleManager.getStyleDeclaration('.imageBank').getStyle('helpImg')}" 
				  toolTip="{resourceManager.getString('cms', 'integrationPrivacyKeyTooltip')}"/>
		<mx:Label width="{LABEL_WIDTH}" text="{resourceManager.getString('cms', 'integrationPrivacyKey')}"
				  styleName="drillDownLabel" toolTip="{resourceManager.getString('cms', 'integrationPrivacyKeyTooltip')}"/>
		<mx:Text width="{TEXT_WIDTH}" styleName="drillDownSubLabel" text="{_category.privacyContexts}"/>
	</mx:HBox>
	<mx:HRule width="90%"/>
	<mx:HBox width="100%">
		<mx:Image source="{StyleManager.getStyleDeclaration('.imageBank').getStyle('helpImg')}"
				  toolTip="{resourceManager.getString('cms', 'contentPrivacyTooltip')}"/>
		<mx:Label text="{resourceManager.getString('cms', 'contentPrivacy')}" width="{LABEL_WIDTH}"
				  styleName="drillDownLabel" toolTip="{resourceManager.getString('cms', 'contentPrivacyTooltip')}"/>
		<mx:VBox width="100%">
			<mx:HBox styleName="plstAddRemoveCont">
				<mx:RadioButton label="{resourceManager.getString('cms','noRestriction')}"
								selected="{_category.privacy == KalturaPrivacyType.ALL}"
								change="{ if((event.target as RadioButton).selected)_category.privacy = KalturaPrivacyType.ALL }"
								groupName="contentPrivacy"/>
				<mx:Label width="100%" text="{resourceManager.getString('cms', 'cp_noRestrictionDesc')}"
						  styleName="smallLabel"/>
			</mx:HBox>
			<mx:HBox styleName="plstAddRemoveCont">
				<mx:RadioButton label="{resourceManager.getString('cms','requiresAuthentication')}"
								selected="{_category.privacy == KalturaPrivacyType.AUTHENTICATED_USERS}"
								change="{ if((event.target as RadioButton).selected)_category.privacy = KalturaPrivacyType.AUTHENTICATED_USERS }"
								groupName="contentPrivacy"/>
				<mx:Label width="100%" text="{resourceManager.getString('cms', 'cp_requiresAuthenticationDesc')}"
						  styleName="smallLabel"/>
			</mx:HBox>
			<mx:HBox styleName="plstAddRemoveCont">
				<mx:RadioButton label="{resourceManager.getString('cms','private')}" groupName="contentPrivacy"
								selected="{_category.privacy == KalturaPrivacyType.MEMBERS_ONLY}"
								change="{ if((event.target as RadioButton).selected)_category.privacy = KalturaPrivacyType.MEMBERS_ONLY }"/>
				<mx:Label width="100%" text="{resourceManager.getString('cms', 'cp_privateDesc')}" styleName="smallLabel"/>
			</mx:HBox>
		</mx:VBox>
	</mx:HBox>
	<mx:HRule width="90%"/>
	<mx:HBox width="100%">
		<mx:Image source="{StyleManager.getStyleDeclaration('.imageBank').getStyle('helpImg')}"
				  toolTip="{resourceManager.getString('cms', 'categoryListingTooltip')}"/>
		<mx:Label text="{resourceManager.getString('cms', 'categoryListing')}" width="{LABEL_WIDTH}"
				  styleName="drillDownLabel" toolTip="{resourceManager.getString('cms', 'categoryListingTooltip')}"/>
		<mx:VBox width="100%">
			<mx:HBox styleName="plstAddRemoveCont">
				<mx:RadioButton label="{resourceManager.getString('cms','noRestriction')}"
								selected="{_category.appearInList == KalturaAppearInListType.PARTNER_ONLY}"
								change="{ if((event.target as RadioButton).selected)_category.appearInList = KalturaAppearInListType.PARTNER_ONLY }"
								groupName="categoryListing"/>
				<mx:Label width="100%" text="{resourceManager.getString('cms', 'cl_noRestrictionDesc')}"
						  styleName="smallLabel"/>
			</mx:HBox>
			<mx:HBox styleName="plstAddRemoveCont">
				<mx:RadioButton label="{resourceManager.getString('cms','private')}"
								selected="{_category.appearInList == KalturaAppearInListType.CATEGORY_MEMBERS_ONLY}"
								change="{ if((event.target as RadioButton).selected)_category.appearInList = KalturaAppearInListType.CATEGORY_MEMBERS_ONLY }"
								groupName="categoryListing"/>
				<mx:Label width="100%" text="{resourceManager.getString('cms', 'cl_privateDesc')}" styleName="smallLabel"/>
			</mx:HBox>
		</mx:VBox>
	</mx:HBox>
	<mx:HRule width="90%"/>
	<mx:HBox width="100%">
		<mx:Image source="{StyleManager.getStyleDeclaration('.imageBank').getStyle('helpImg')}" 
				  toolTip="{resourceManager.getString('cms', 'whoCanAddContentTooltip')}"/>
		<mx:Text text="{resourceManager.getString('cms', 'whoCanAddContent')}" width="{LABEL_WIDTH}"
				 styleName="drillDownLabel" toolTip="{resourceManager.getString('cms', 'whoCanAddContentTooltip')}"/>
		<mx:VBox width="100%">
			<mx:HBox styleName="plstAddRemoveCont">
				<mx:RadioButton label="{resourceManager.getString('cms','noRestriction')}"
								selected="{_category.contributionPolicy == KalturaContributionPolicyType.ALL}"
								change="{ if((event.target as RadioButton).selected)_category.contributionPolicy = KalturaContributionPolicyType.ALL }"
								groupName="whoCanAddContent"/>
				<mx:Label width="100%" text="{resourceManager.getString('cms', 'wa_noRestrictionDesc')}"
						  styleName="smallLabel"/>
			</mx:HBox>
			<mx:HBox styleName="plstAddRemoveCont">
				<mx:RadioButton label="{resourceManager.getString('cms','private')}"
								selected="{_category.contributionPolicy == KalturaContributionPolicyType.MODERATOR}"
								change="{ if((event.target as RadioButton).selected)_category.contributionPolicy = KalturaContributionPolicyType.MODERATOR }"
								groupName="whoCanAddContent"/>
				<mx:Label width="100%" text="{resourceManager.getString('cms', 'wa_privateDesc')}" styleName="smallLabel"/>
			</mx:HBox>
		</mx:VBox>
	</mx:HBox>
	<mx:HRule width="90%"/>
	<mx:HBox width="100%">
		<mx:Image source="{StyleManager.getStyleDeclaration('.imageBank').getStyle('helpImg')}"
				  toolTip="{resourceManager.getString('cms', 'inheritEndUserSpecificTooltip')}"/>
		<mx:Text text="{resourceManager.getString('cms', 'inheritEndUserSpecific')}" width="{LABEL_WIDTH}"
				 styleName="drillDownLabel" toolTip="{resourceManager.getString('cms', 'inheritEndUserSpecificTooltip')}"/>
		<mx:VBox width="100%">
			<mx:HBox styleName="plstAddRemoveCont">
				<mx:RadioButton label="{resourceManager.getString('cms','no')}" id="inheritNo"
								selected="{_category.inheritanceType == KalturaInheritanceType.MANUAL}"
								change="inheritNo_changeHandler(event)"
								groupName="inheritEndUserSpecific"/>
				<mx:Label width="100%" text="{resourceManager.getString('cms', 'inheritEndUserSpecificNoDesc')}"
						  styleName="smallLabel"/>
			</mx:HBox>
			<mx:HBox styleName="plstAddRemoveCont">
				<mx:RadioButton label="{resourceManager.getString('cms','yes')}" id="inheritYes"
								selected="{_category.inheritanceType == KalturaInheritanceType.INHERIT}"
								change="inheritYes_changeHandler(event)"
								groupName="inheritEndUserSpecific" enabled="{category.parentId > 0}"/>
				<mx:Label width="100%" text="{resourceManager.getString('cms', 'inheritEndUserSpecificYesDesc')}"
						  styleName="smallLabel"/>
			</mx:HBox>
		</mx:VBox>
	</mx:HBox>
	<mx:Spacer height="10"/>
	<mx:VBox width="90%" styleName="flavorsReplacementVBox">
		<mx:HBox width="100%">
			<mx:Label text="{resourceManager.getString('cms', 'endUserSpecificActionPer')}" styleName="drillDownLabel"/>
			<mx:HBox styleName="noPadding" visible="{_category.inheritanceType == KalturaInheritanceType.INHERIT}">
				<mx:Label text="{resourceManager.getString('cms', 'inheritedFrom')}" styleName="drillDownLabel"/>	
				<mx:Label styleName="drillDownSubLabel" maxWidth="{TEXT_WIDTH}"  
						  text="{model.inheritedParentCategory ? model.inheritedParentCategory.fullName : model.parentCategory.fullName}" />
			</mx:HBox>
		</mx:HBox>
		<mx:HBox width="100%">
			<mx:Label text="{resourceManager.getString('cms', 'owner')}" styleName="drillDownLabel"/>
			<mx:Text maxWidth="{TEXT_WIDTH}" styleName="drillDownSubLabel" 
					 text="{_category.owner ? _category.owner : resourceManager.getString('cms', 'notSpec')}"/>
			<mx:LinkButton label="{resourceManager.getString('cms', 'change')}"
						   enabled="{_category.inheritanceType == KalturaInheritanceType.MANUAL}" click="changeOwner()"/>
			<mx:VRule height="10"/>
			<mx:Label text="{resourceManager.getString('cms', 'users')}" styleName="drillDownLabel"/>
			<mx:Text styleName="drillDownSubLabel"
					 text="{resourceManager.getString('cms', 'membersCount', [_category.membersCount, _category.pendingMembersCount])}"/>
			<mx:LinkButton label="{resourceManager.getString('cms', 'change')}" click="openEndUserPermissions()" />
		</mx:HBox>
	</mx:VBox>

	<mx:Spacer height="10"/>
	<mx:HBox width="100%" styleName="noPadding">
		<mx:Label width="{LABEL_WIDTH}" styleName="drillDownLabel"
				  text="{resourceManager.getString('cms', 'joinGroupPolicy')}"/>
		<mx:ComboBox id="policyCb" change="policyCb_changeHandler(event)" 
					 enabled="{_category.inheritanceType == KalturaInheritanceType.MANUAL}"/>
	</mx:HBox>
	<mx:HBox width="100%" styleName="noPadding">
		<mx:Label width="{LABEL_WIDTH}" styleName="drillDownLabel"
				  text="{resourceManager.getString('cms', 'defaultPermissionLevel')}"/>
		<mx:ComboBox id="levelCb" change="levelCb_changeHandler(event)" 
					 enabled="{_category.inheritanceType == KalturaInheritanceType.MANUAL}"/>
	</mx:HBox>
</mx:VBox>
